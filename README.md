# UP-Retinex: ä½å…‰ç…§å›¾åƒå¢å¼ºæ¡†æ¶

## ğŸ“˜ ç®€ä»‹

UP-Retinexæ˜¯ä¸€ä¸ªåŸºäºRetinexç†è®ºçš„æ·±åº¦å­¦ä¹ å›¾åƒå¢å¼ºæ¡†æ¶ï¼Œä¸“ä¸ºè§£å†³ä½å…‰ç…§æ¡ä»¶ä¸‹çš„å›¾åƒè´¨é‡é—®é¢˜è€Œè®¾è®¡ã€‚é€šè¿‡å…ˆè¿›çš„ç¥ç»ç½‘ç»œæ¶æ„å’Œç²¾å¿ƒè®¾è®¡çš„æŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬çš„æ–¹æ³•èƒ½å¤Ÿæœ‰æ•ˆåœ°æå‡å›¾åƒäº®åº¦ã€å¢å¼ºå¯¹æ¯”åº¦ï¼ŒåŒæ—¶ä¿æŒè‡ªç„¶çš„é¢œè‰²å’Œç»†èŠ‚ã€‚

## ğŸ¯ ç‰¹æ€§

- **å…ˆè¿›çš„Retinexæ¶æ„**ï¼šé‡‡ç”¨FAM(Feature Aggregation Module)å’ŒIENet(Image Enhancement Network)ç»„åˆçš„UP-Retinexæ¶æ„
- **æ— ç›‘ç£å­¦ä¹ **ï¼šå®Œå…¨åŸºäºæ— ç›‘ç£æŸå¤±å‡½æ•°è®­ç»ƒï¼Œæ— éœ€æˆå¯¹çš„ä½å…‰/æ­£å¸¸å…‰å›¾åƒ
- **è‡ªé€‚åº”å‚æ•°è°ƒæ•´**ï¼šæ ¹æ®å›¾åƒå†…å®¹åŠ¨æ€è°ƒæ•´å¢å¼ºå‚æ•°
- **å¤šå°ºåº¦å¢å¼º**ï¼šæ”¯æŒåœ¨ä¸åŒå°ºåº¦ä¸Šè¿›è¡Œå›¾åƒå¢å¼ºä»¥ä¿ç•™ç»†èŠ‚
- **å†…å®¹æ„ŸçŸ¥å¢å¼º**ï¼šè¯†åˆ«å›¾åƒä¸­çš„é‡è¦åŒºåŸŸå¹¶é’ˆå¯¹æ€§å¢å¼º
- **Letterboxå¤„ç†ç­–ç•¥**ï¼šæ™ºèƒ½ä¿æŒå›¾åƒå®½é«˜æ¯”çš„åŒæ—¶è¿›è¡Œå¤„ç†
- **ç®€åŒ–ç‰ˆå¢å¼ºå·¥å…·**ï¼šæ— éœ€è®­ç»ƒå³å¯ç›´æ¥ä½¿ç”¨çš„å›¾åƒå¢å¼ºå·¥å…·

## ğŸ“š ç†è®ºåŸºç¡€

Retinexç†è®ºè®¤ä¸ºå›¾åƒå½¢æˆè¿‡ç¨‹å¯ä»¥åˆ†è§£ä¸ºç…§åº¦åˆ†é‡å’Œåå°„åˆ†é‡ï¼š
$$S(x, y) = R(x, y) \times L(x, y)$$

å…¶ä¸­ï¼š
- $S(x, y)$ æ˜¯è§‚å¯Ÿåˆ°çš„å›¾åƒ
- $R(x, y)$ æ˜¯åå°„åˆ†é‡(ç‰©ä½“çš„æœ¬è´¨å±æ€§)
- $L(x, y)$ æ˜¯ç…§åº¦åˆ†é‡(ç…§æ˜æ¡ä»¶çš„å½±å“)

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¼°è®¡ç…§åº¦åˆ†é‡$L$å¹¶æ¢å¤åå°„åˆ†é‡$R$ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### FAM (Feature Aggregation Module)
FAMæ¨¡å—é€šè¿‡å¤šå°ºåº¦ç‰¹å¾æå–å’Œæ³¨æ„åŠ›æœºåˆ¶æ¥æ•è·å…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸®åŠ©ç½‘ç»œæ›´å¥½åœ°ç†è§£å›¾åƒçš„å…‰ç…§åˆ†å¸ƒã€‚

### IENet (Image Enhancement Network)
IENetç”±ä¸‰ä¸ªå­ç½‘ç»œç»„æˆï¼š
1. **Decomposition Net**ï¼šå°†è¾“å…¥å›¾åƒåˆ†è§£ä¸ºç…§åº¦å›¾å’Œåå°„å›¾
2. **Enhancement Net**ï¼šå¢å¼ºåå°„å›¾ä»¥æé«˜è§†è§‰è´¨é‡
3. **Adjustment Net**ï¼šè°ƒæ•´ç…§åº¦å›¾ä»¥è·å¾—æ›´å¥½çš„å…‰ç…§æ•ˆæœ

### UP-Retinex
æœ€ç»ˆè¾“å‡ºé€šè¿‡ä»¥ä¸‹å…¬å¼è®¡ç®—ï¼š
$$J = R_{enhanced} \times L_{adjusted}$$

## âš™ï¸ å®‰è£…è¯´æ˜

### ç¯å¢ƒè¦æ±‚
- Python >= 3.7
- PyTorch >= 1.8.0
- CUDA >= 10.2 (æ¨èï¼Œç”¨äºGPUåŠ é€Ÿ)
- å…¶ä»–ä¾èµ–é¡¹è§`requirements.txt`

### ç¯å¢ƒæ­å»º
```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/retinex-enhancement.git
cd retinex-enhancement

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ(æ¨è)
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ•°æ®é›†å‡†å¤‡

ç»„ç»‡æ‚¨çš„æ•°æ®é›†å¦‚ä¸‹ï¼š
```
data/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ 0001.png
â”‚   â”œâ”€â”€ 0002.png
â”‚   â””â”€â”€ ...
â””â”€â”€ test/
    â”œâ”€â”€ 0001.png
    â”œâ”€â”€ 0002.png
    â””â”€â”€ ...
```

æ”¯æŒçš„å›¾åƒæ ¼å¼ï¼šJPEG, PNG, BMP

### è®­ç»ƒæ¨¡å‹

```bash
# åŸºç¡€è®­ç»ƒ
python main.py --mode train --train_data_path ./data/train --val_data_path ./data/test

# è‡ªå®šä¹‰è¶…å‚æ•°
python main.py --mode train --train_data_path ./data/train --val_data_path ./data/test \
               --learning_rate 1e-4 --batch_size 8 --epochs 200
```

### æ¨ç†é¢„æµ‹

```bash
# å•å¼ å›¾åƒé¢„æµ‹
python main.py --mode predict --input_path ./test_image.jpg --output_dir ./results

# æ‰¹é‡é¢„æµ‹
python main.py --mode predict --input_path ./data/test --output_dir ./results
```

### ç®€åŒ–ç‰ˆå›¾åƒå¢å¼º

å¯¹äºä¸éœ€è¦è®­ç»ƒçš„å¿«é€Ÿå›¾åƒå¢å¼ºï¼Œæˆ‘ä»¬æä¾›äº†ç®€åŒ–ç‰ˆæœ¬ï¼š

```bash
# å•å¼ å›¾åƒå¢å¼º
python simple_enhance.py --input ./your_image.jpg --output ./results

# æ‰¹é‡å›¾åƒå¢å¼º
python simple_enhance.py --input ./data/input_directory --output ./results

# ä½¿ç”¨letterboxç­–ç•¥ä¿æŒå®½é«˜æ¯”
python simple_enhance.py --input ./your_image.jpg --output ./results --letterbox --image_size 320

# å¤šå°ºåº¦å¢å¼º
python simple_enhance.py --input ./your_image.jpg --output ./results --multi_scale

# å†…å®¹æ„ŸçŸ¥å¢å¼º
python simple_enhance.py --input ./your_image.jpg --output ./results --content_aware
```

**ç®€åŒ–ç‰ˆå‚æ•°ï¼š**
- `--input`ï¼šè¾“å…¥å›¾åƒè·¯å¾„æˆ–ç›®å½•ï¼ˆå¿…éœ€ï¼‰
- `--output`ï¼šä¿å­˜ç»“æœçš„ç›®å½•(é»˜è®¤ï¼š`./results`)
- `--image_size`ï¼šå¤„ç†å›¾åƒå°ºå¯¸(å¯é€‰ï¼Œé»˜è®¤ä¸ºåŸå›¾å°ºå¯¸)
- `--letterbox`ï¼šä½¿ç”¨letterboxç­–ç•¥ä¿æŒå®½é«˜æ¯”(å¯é€‰)
- `--device`ï¼šä½¿ç”¨çš„è®¾å¤‡(cuda/cpu)
- `--multi_scale`ï¼šå¯ç”¨å¤šå°ºåº¦å¢å¼ºæ¨¡å¼
- `--content_aware`ï¼šå¯ç”¨å†…å®¹æ„ŸçŸ¥å¢å¼ºæ¨¡å¼

### 5. ä¸»ç¨‹åºä¸­çš„ç®€åŒ–å¢å¼ºæ¨¡å¼

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä¸»ç¨‹åºä½¿ç”¨ç®€åŒ–å¢å¼ºæ¨¡å¼ï¼š

**å•å¼ å›¾åƒå¢å¼ºï¼š**
```bash
python main.py --mode enhance --input_path ./your_image.jpg --output_dir ./results
```

**æ‰¹é‡å›¾åƒå¢å¼ºï¼š**
```bash
python main.py --mode enhance --input_path ./data/input_directory --output_dir ./results
```

### 6. é«˜çº§å¢å¼ºåŠŸèƒ½

æœ¬é¡¹ç›®å®ç°äº†å¤šç§é«˜çº§å›¾åƒå¢å¼ºæŠ€æœ¯ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ï¼š

#### å¤šå°ºåº¦å¢å¼º (Multi-Scale Enhancement)
å¤šå°ºåº¦å¢å¼ºæŠ€æœ¯é€šè¿‡æ„å»ºå›¾åƒé‡‘å­—å¡”ï¼Œåœ¨ä¸åŒå°ºåº¦ä¸Šè¿›è¡Œç‰¹å¾æå–å’Œå¢å¼ºï¼Œèƒ½å¤Ÿæ›´å¥½åœ°ä¿ç•™å›¾åƒç»†èŠ‚å¹¶æå‡æ•´ä½“è§†è§‰æ•ˆæœã€‚

ç‰¹ç‚¹ï¼š
- åœ¨å¤šä¸ªå°ºåº¦ä¸Šæå–å›¾åƒç‰¹å¾
- æœ‰æ•ˆä¿ç•™ç»†èŠ‚ä¿¡æ¯
- æå‡å›¾åƒçš„æ•´ä½“å¯¹æ¯”åº¦å’Œæ¸…æ™°åº¦

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results --multi_scale
```

#### å†…å®¹æ„ŸçŸ¥å¢å¼º (Content-Aware Enhancement)
å†…å®¹æ„ŸçŸ¥å¢å¼ºæŠ€æœ¯ç»“åˆäº†æ˜¾è‘—æ€§æ£€æµ‹å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼Œèƒ½å¤Ÿè¯†åˆ«å›¾åƒä¸­çš„é‡è¦åŒºåŸŸï¼Œå¹¶é’ˆå¯¹æ€§åœ°å¢å¼ºè¿™äº›åŒºåŸŸï¼Œä»è€Œè·å¾—æ›´è‡ªç„¶çš„å¢å¼ºæ•ˆæœã€‚

ç‰¹ç‚¹ï¼š
- è‡ªåŠ¨è¯†åˆ«å›¾åƒä¸­çš„æ˜¾è‘—åŒºåŸŸ
- æ ¹æ®å†…å®¹é‡è¦æ€§è°ƒæ•´å¢å¼ºå¼ºåº¦
- æä¾›æ›´åŠ è‡ªç„¶å’Œç¬¦åˆäººçœ¼è§†è§‰çš„å¢å¼ºæ•ˆæœ

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results --content_aware
```

### 4. TensorBoardç›‘æ§

ä½¿ç”¨TensorBoardç›‘æ§è®­ç»ƒè¿›åº¦ï¼š

```bash
tensorboard --logdir ./checkpoints/logs
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:6006

## ğŸ“Š æŸå¤±å‡½æ•°

æ¨¡å‹ä½¿ç”¨å››ç§æ— ç›‘ç£æŸå¤±å‡½æ•°ï¼š

### 1. æ›å…‰æ§åˆ¶æŸå¤±(L_exp)
çº¦æŸå¢å¼ºå›¾åƒçš„å¹³å‡å¼ºåº¦è¾¾åˆ°ç›®æ ‡æ°´å¹³(0.6)ã€‚

$$\mathcal{L}_{exp} = \frac{1}{M} \sum_{k=1}^{M} |Y_k - E|$$

### 2. ç»“æ„æ„ŸçŸ¥å¹³æ»‘æ€§æŸå¤±(L_smooth)
ç¡®ä¿å…‰ç…§å¹³æ»‘åŒæ—¶ä¿ç•™è¾¹ç¼˜ã€‚

$$\mathcal{L}_{smooth} = \sum || \nabla I \circ \exp(-\lambda |\nabla S|) ||_1$$

### 3. é¢œè‰²æ’å¸¸æ€§æŸå¤±(L_col)
åŸºäºç°åº¦ä¸–ç•Œå‡è®¾æ¥æ ¡æ­£é¢œè‰²åå·®ã€‚

$$\mathcal{L}_{col} = \sum_{\forall (p,q) \in (R,G,B), p \neq q} (J^p - J^q)^2$$

### 4. ç©ºé—´ä¸€è‡´æ€§æŸå¤±(L_spa)
ä¿æŒä»è¾“å…¥åˆ°è¾“å‡ºçš„çº¹ç†ç»“æ„ã€‚

$$\mathcal{L}_{spa} = \frac{1}{K} \sum_{i=1}^{K} || \nabla R_i - \nabla S_i ||^2$$

### æ€»æŸå¤±

$$\mathcal{L}_{total} = \mathcal{L}_{exp} + \omega_{smooth}\mathcal{L}_{smooth} + \omega_{col}\mathcal{L}_{col} + \omega_{spa}\mathcal{L}_{spa}$$

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ models/               # æ¨¡å‹æ¶æ„ç›®å½•
â”‚   â””â”€â”€ model.py          # æ¨¡å‹æ¶æ„(FAM, IENet, UP_Retinex)
â”œâ”€â”€ losses/               # æŸå¤±å‡½æ•°ç›®å½•
â”‚   â””â”€â”€ loss.py           # æŸå¤±å‡½æ•°
â”œâ”€â”€ datasets/             # æ•°æ®åŠ è½½å·¥å…·ç›®å½•
â”‚   â””â”€â”€ dataset.py        # æ•°æ®åŠ è½½å·¥å…·
â”œâ”€â”€ trainers/             # è®­ç»ƒè„šæœ¬ç›®å½•
â”‚   â””â”€â”€ train.py          # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ predictors/           # æ¨ç†è„šæœ¬ç›®å½•
â”‚   â””â”€â”€ predict.py        # æ¨ç†è„šæœ¬
â”œâ”€â”€ enhancers/            # å›¾åƒå¢å¼ºåŠŸèƒ½ç›®å½•
â”‚   â”œâ”€â”€ simple_enhance.py # ç®€åŒ–ç‰ˆå›¾åƒå¢å¼ºæ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ adaptive_params.py# è‡ªé€‚åº”å‚æ•°è°ƒæ•´æ¨¡å—
â”‚   â”œâ”€â”€ multi_scale.py    # å¤šå°ºåº¦å¢å¼ºæ¨¡å—
â”‚   â””â”€â”€ content_aware.py  # å†…å®¹æ„ŸçŸ¥å¢å¼ºæ¨¡å—
â”œâ”€â”€ utils/                # å®ç”¨å·¥å…·ç›®å½•
â”‚   â”œâ”€â”€ letterbox.py      # Letterboxå¤„ç†å·¥å…·
â”‚   â””â”€â”€ utils.py          # å®ç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ main.py               # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ simple_enhance.py     # ç®€åŒ–ç‰ˆå›¾åƒå¢å¼ºå·¥å…·ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è®­ç»ƒï¼‰
â”œâ”€â”€ enhancement_comparison_report.md # å¢å¼ºæ•ˆæœå¯¹æ¯”æŠ¥å‘Š
â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–
â”œâ”€â”€ Development Documentation.md  # è¯¦ç»†è§„èŒƒè¯´æ˜
â”œâ”€â”€ REFACTORING_SUMMARY.md       # é‡æ„æ€»ç»“
â””â”€â”€ README.md             # æœ¬æ–‡æ¡£
```

## ğŸ§ª æµ‹è¯•ç»„ä»¶

### æµ‹è¯•æ•´ä¸ªé¡¹ç›®
```bash
python test_project.py
```

### æµ‹è¯•æ¨¡å‹æ¶æ„
```bash
python models/model.py
```

### æµ‹è¯•æŸå¤±å‡½æ•°
```bash
python losses/loss.py
```

### æµ‹è¯•æ•°æ®é›†åŠ è½½å™¨
```bash
python datasets/dataset.py ./data/train
```

## ğŸ”§ è¶…å‚æ•°

é»˜è®¤è¶…å‚æ•°(æ ¹æ®è§„èŒƒ)ï¼š

| å‚æ•° | å€¼ |
|-----------|-------|
| å­¦ä¹ ç‡ | 1e-4 |
| æƒé‡è¡°å‡ | 1e-5 |
| æ‰¹å¤„ç†å¤§å° | 8 |
| å›¾åƒå°ºå¯¸ | 256Ã—256 |
| æ›å…‰æŸå¤±æƒé‡ | 10.0 |
| å¹³æ»‘æ€§æŸå¤±æƒé‡ | 1.0 |
| é¢œè‰²æŸå¤±æƒé‡ | 0.5 |
| ç©ºé—´æŸå¤±æƒé‡ | 1.0 |

## ğŸ“ˆ é¢„æœŸç»“æœ

æ¨¡å‹åº”äº§ç”Ÿï¼š
- **å¢å¼ºå›¾åƒ**ï¼šäº®åº¦å’Œå¯¹æ¯”åº¦å¾—åˆ°æ”¹å–„
- **å…‰ç…§å›¾**ï¼šæ˜¾ç¤ºä¼°è®¡çš„å…‰ç…§åˆ†å¸ƒ
- **å¯¹æ¯”å›¾åƒ**ï¼šæ˜¾ç¤ºè¾“å…¥ã€è¾“å‡ºå’Œå…‰ç…§çš„å¹¶æ’æ¯”è¾ƒ

## ğŸ› æ•…éšœæ’é™¤

### å†…å­˜ä¸è¶³(OOM)é”™è¯¯
- å‡å°‘æ‰¹å¤„ç†å¤§å°ï¼š`--batch_size 4`
- å‡å°‘å›¾åƒå°ºå¯¸ï¼š`--image_size 224`
- å¯¹äºæ¨ç†ï¼Œä½¿ç”¨letterboxç­–ç•¥å¹¶è®¾ç½®åˆé€‚çš„å°ºå¯¸ï¼š`--letterbox --image_size 1024`

### è®­ç»ƒæŸå¤±ä¸ä¸‹é™
- æ£€æŸ¥å›¾åƒæ˜¯å¦æ­£ç¡®å½’ä¸€åŒ–[0, 1]
- éªŒè¯æŸå¤±æƒé‡æ˜¯å¦åˆé€‚
- å°è¯•è°ƒæ•´å­¦ä¹ ç‡

### å¢å¼ºè´¨é‡å·®
- è®­ç»ƒæ›´å¤šè½®æ¬¡(æ¨è100-200è½®)
- ç¡®ä¿è®­ç»ƒæ•°æ®å¤šæ ·æ€§å……è¶³
- å¦‚å‡ºç°ç‰¹å®šä¼ªå½±ï¼Œè°ƒæ•´æŸå¤±æƒé‡

### é«˜çº§å¢å¼ºåŠŸèƒ½é—®é¢˜
- ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ï¼š`pip install -r requirements.txt`
- æ£€æŸ¥è¾“å…¥å›¾åƒæ ¼å¼æ˜¯å¦ä¸ºæ”¯æŒçš„æ ¼å¼ï¼ˆJPEG, PNGç­‰ï¼‰
- å¤šå°ºåº¦å¢å¼ºå’Œå†…å®¹æ„ŸçŸ¥å¢å¼ºå¯èƒ½éœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºï¼Œå¦‚æœé‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨letterboxç­–ç•¥å¹¶è®¾ç½®åˆé€‚çš„å°ºå¯¸ï¼š`--letterbox --image_size 512`

## ğŸ“š å‚è€ƒæ–‡çŒ®

- Retinexç†è®ºï¼šLand, E. H. (1977). è§†ç½‘è†œç†è®ºä¸è‰²å½©è§†è§‰ã€‚ã€Šç§‘å­¦ç¾å›½äººã€‹ã€‚
- HIDO-Netï¼šç‰¹å¾èšåˆæ¨¡å—çµæ„Ÿæ¥æº

## ğŸ“ å¼•ç”¨

å¦‚æœæ‚¨åœ¨ç ”ç©¶ä¸­ä½¿ç”¨æ­¤ä»£ç ï¼Œè¯·å¼•ç”¨ï¼š
```