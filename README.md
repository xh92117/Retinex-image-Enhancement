# UP-Retinex: æ— ç›‘ç£ç‰©ç†å¼•å¯¼çš„Retinexç½‘ç»œ

åŸºäºPyTorchå®ç°çš„UP-Retinexï¼Œè¿™æ˜¯ä¸€ç§åŸºäºRetinexç†è®ºçš„æ— ç›‘ç£æ·±åº¦å­¦ä¹ æ–¹æ³•ï¼Œç”¨äºä½å…‰ç…§å›¾åƒå¢å¼ºã€‚

## ğŸ“‹ æ¦‚è¿°

UP-Retinexæ˜¯ä¸€ç§è½»é‡çº§ç¥ç»ç½‘ç»œï¼Œå¯åœ¨æ— éœ€é…å¯¹è®­ç»ƒæ•°æ®çš„æƒ…å†µä¸‹å¢å¼ºä½å…‰ç…§å›¾åƒã€‚å®ƒåˆ©ç”¨ï¼š
- **Retinexç†è®º**ï¼šå°†å›¾åƒåˆ†è§£ä¸ºåå°„ç‡å’Œå…‰ç…§åˆ†é‡
- **ç‰¹å¾èšåˆæ¨¡å—(FAM)**ï¼šæ•è·å¤šå°ºåº¦ç‰¹å¾ä»¥ä¿æŒç»“æ„å®Œæ•´æ€§
- **æ— ç›‘ç£å­¦ä¹ **ï¼šä½¿ç”¨ç‰©ç†å…ˆéªŒå’Œæ— å‚è€ƒæŸå¤±å‡½æ•°è¿›è¡Œè®­ç»ƒ

### ä¸»è¦ç‰¹æ€§
- âœ… **æ— éœ€é…å¯¹æ•°æ®** - ä»…ä½¿ç”¨ä½å…‰ç…§å›¾åƒè¿›è¡Œè®­ç»ƒ
- âœ… **ç‰©ç†å¼•å¯¼** - åŸºäºRetinexåˆ†è§£ç†è®º
- âœ… **è½»é‡çº§æ¶æ„** - é«˜æ•ˆä¸”å¿«é€Ÿæ¨ç†
- âœ… **é«˜è´¨é‡ç»“æœ** - ä¿ç•™ç»†èŠ‚å’Œè‡ªç„¶è‰²å½©

## ğŸ¯ ç†è®ºåŸºç¡€

è¯¥æ¨¡å‹éµå¾ªRetinexåˆ†è§£ï¼š

$$S = R \circ I$$

å…¶ä¸­ï¼š
- **S** (æºå›¾åƒ)ï¼šè¾“å…¥çš„ä½å…‰ç…§å›¾åƒ
- **I** (å…‰ç…§)ï¼šä¼°è®¡çš„å…‰ç…§å›¾
- **R** (åå°„ç‡)ï¼šå¢å¼ºåçš„ç»“æœ

**é‡å»ºå…¬å¼ï¼š**

$$R = \frac{S}{I + \epsilon}$$

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç‰¹å¾èšåˆæ¨¡å—(FAM)
- **åˆ†æ”¯1**ï¼š1Ã—1å·ç§¯
- **åˆ†æ”¯2**ï¼š3Ã—3æœ€å¤§æ± åŒ– â†’ 1Ã—1å·ç§¯
- **åˆ†æ”¯3**ï¼š3Ã—3å·ç§¯ â†’ 3Ã—3å·ç§¯
- **åˆ†æ”¯4**ï¼š3Ã—3å·ç§¯ â†’ 3Ã—3è†¨èƒ€å·ç§¯
- **èåˆ**ï¼šè¿æ¥æ‰€æœ‰åˆ†æ”¯ â†’ 1Ã—1å·ç§¯

### å…‰ç…§ä¼°è®¡ç½‘ç»œ(IE-Net)
- **è¾“å…¥å±‚**ï¼šå·ç§¯(3 â†’ 32é€šé“)
- **ç¼–ç å™¨**ï¼š2å±‚[å·ç§¯ + ReLU + FAM]
- **ç“¶é¢ˆå±‚**ï¼šFAMå—
- **è§£ç å™¨**ï¼š2å±‚[å·ç§¯ + ReLU]
- **è¾“å‡º**ï¼š1Ã—1å·ç§¯ â†’ Sigmoid(3é€šé“å…‰ç…§å›¾)

## ğŸ“¦ å®‰è£…è¯´æ˜

### ç¯å¢ƒè¦æ±‚
- Python >= 3.8
- PyTorch >= 2.0.0
- CUDA (å¯é€‰ï¼Œç”¨äºGPUåŠ é€Ÿ)

### ç¯å¢ƒæ­å»º

```bash
# å…‹éš†ä»“åº“
git clone <your-repo-url>
cd Retinex-Image-Enhancement

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡æ•°æ®é›†

å°†ä½å…‰ç…§å›¾åƒæŒ‰ä»¥ä¸‹æ–¹å¼ç»„ç»‡ï¼š

```
data/
  train/
    image1.jpg
    image2.jpg
    ...
  test/
    test1.jpg
    test2.jpg
    ...
```

### 2. è®­ç»ƒæ¨¡å‹

åœ¨ä½å…‰ç…§å›¾åƒä¸Šè®­ç»ƒæ¨¡å‹ï¼š

```bash
python trainers/train.py --train_dir ./data/train --save_dir ./checkpoints --num_epochs 100 --batch_size 8
```

**è®­ç»ƒå‚æ•°ï¼š**
- `--train_dir`ï¼šè®­ç»ƒå›¾åƒç›®å½•è·¯å¾„
- `--save_dir`ï¼šä¿å­˜æ£€æŸ¥ç‚¹çš„ç›®å½•(é»˜è®¤ï¼š`./checkpoints`)
- `--num_epochs`ï¼šè®­ç»ƒè½®æ•°(é»˜è®¤ï¼š100)
- `--batch_size`ï¼šæ‰¹å¤„ç†å¤§å°(é»˜è®¤ï¼š8)
- `--image_size`ï¼šè®­ç»ƒè£å‰ªçš„å›¾åƒå°ºå¯¸(é»˜è®¤ï¼š640)
- `--lr`ï¼šå­¦ä¹ ç‡(é»˜è®¤ï¼š1e-4)
- `--weight_decay`ï¼šæƒé‡è¡°å‡(é»˜è®¤ï¼š1e-5)

**æŸå¤±å‡½æ•°æƒé‡ï¼š**
- `--weight_exp`ï¼šæ›å…‰æŸå¤±æƒé‡(é»˜è®¤ï¼š10.0)
- `--weight_smooth`ï¼šå¹³æ»‘æ€§æŸå¤±æƒé‡(é»˜è®¤ï¼š1.0)
- `--weight_col`ï¼šé¢œè‰²æ’å¸¸æ€§æŸå¤±æƒé‡(é»˜è®¤ï¼š0.5)
- `--weight_spa`ï¼šç©ºé—´ä¸€è‡´æ€§æŸå¤±æƒé‡(é»˜è®¤ï¼š1.0)

**æ¢å¤è®­ç»ƒï¼š**
```bash
python trainers/train.py --train_dir ./data/train --resume ./checkpoints/latest_model.pth
```

### 3. æ¨ç†é¢„æµ‹

ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å¢å¼ºå›¾åƒï¼š

**å•å¼ å›¾åƒï¼š**
```bash
python predictors/predict.py --checkpoint ./checkpoints/best_model.pth --input ./data/test/image.jpg --output ./results
```

**æ‰¹é‡å¤„ç†ï¼š**
```bash
python predictors/predict.py --checkpoint ./checkpoints/best_model.pth --input ./data/test --output ./results
```

**æ¨ç†å‚æ•°ï¼š**
- `--checkpoint`ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹è·¯å¾„
- `--input`ï¼šè¾“å…¥å›¾åƒæˆ–ç›®å½•è·¯å¾„
- `--output`ï¼šä¿å­˜ç»“æœçš„ç›®å½•(é»˜è®¤ï¼š`./results`)
- `--max_size`ï¼šæœ€å¤§å›¾åƒå°ºå¯¸(å¯é€‰ï¼Œç”¨äºå†…å­˜é™åˆ¶)
- `--no_comparison`ï¼šä¸ä¿å­˜å¯¹æ¯”å›¾åƒ
- `--device`ï¼šä½¿ç”¨çš„è®¾å¤‡(cuda/cpu)

### 4. ç®€åŒ–ç‰ˆå›¾åƒå¢å¼ºï¼ˆæ— éœ€è®­ç»ƒï¼‰

å¦‚æœæ‚¨åªæƒ³ç›´æ¥å¯¹å›¾åƒè¿›è¡Œå¢å¼ºè€Œä¸æƒ³è®­ç»ƒæ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ç®€åŒ–ç‰ˆå·¥å…·ï¼š

**å•å¼ å›¾åƒå¢å¼ºï¼š**
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results
```

**æ‰¹é‡å›¾åƒå¢å¼ºï¼š**
```bash
python simple_enhance.py --input ./data/input_directory --output ./results
```

**é«˜çº§å¢å¼ºæ¨¡å¼ï¼š**
```bash
# å¤šå°ºåº¦å¢å¼º
python simple_enhance.py --input ./your_image.jpg --output ./results --multi_scale

# å†…å®¹æ„ŸçŸ¥å¢å¼º
python simple_enhance.py --input ./your_image.jpg --output ./results --content_aware
```

**ç®€åŒ–ç‰ˆå‚æ•°ï¼š**
- `--input`ï¼šè¾“å…¥å›¾åƒè·¯å¾„æˆ–ç›®å½•ï¼ˆå¿…éœ€ï¼‰
- `--output`ï¼šä¿å­˜ç»“æœçš„ç›®å½•(é»˜è®¤ï¼š`./results`)
- `--max_size`ï¼šæœ€å¤§å›¾åƒå°ºå¯¸(å¯é€‰ï¼Œç”¨äºå†…å­˜é™åˆ¶)
- `--device`ï¼šä½¿ç”¨çš„è®¾å¤‡(cuda/cpu)
- `--multi_scale`ï¼šå¯ç”¨å¤šå°ºåº¦å¢å¼ºæ¨¡å¼
- `--content_aware`ï¼šå¯ç”¨å†…å®¹æ„ŸçŸ¥å¢å¼ºæ¨¡å¼

### 5. ä¸»ç¨‹åºä¸­çš„ç®€åŒ–å¢å¼ºæ¨¡å¼

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä¸»ç¨‹åºä½¿ç”¨ç®€åŒ–å¢å¼ºæ¨¡å¼ï¼š

**å•å¼ å›¾åƒå¢å¼ºï¼š**
```bash
python main.py --mode enhance --input_path ./your_image.jpg --output_dir ./results
```

**æ‰¹é‡å›¾åƒå¢å¼ºï¼š**
```bash
python main.py --mode enhance --input_path ./data/input_directory --output_dir ./results
```

### 6. é«˜çº§å¢å¼ºåŠŸèƒ½

æœ¬é¡¹ç›®å®ç°äº†å¤šç§é«˜çº§å›¾åƒå¢å¼ºæŠ€æœ¯ï¼Œä»¥æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ï¼š

#### å¤šå°ºåº¦å¢å¼º (Multi-Scale Enhancement)
å¤šå°ºåº¦å¢å¼ºæŠ€æœ¯é€šè¿‡æ„å»ºå›¾åƒé‡‘å­—å¡”ï¼Œåœ¨ä¸åŒå°ºåº¦ä¸Šè¿›è¡Œç‰¹å¾æå–å’Œå¢å¼ºï¼Œèƒ½å¤Ÿæ›´å¥½åœ°ä¿ç•™å›¾åƒç»†èŠ‚å¹¶æå‡æ•´ä½“è§†è§‰æ•ˆæœã€‚

ç‰¹ç‚¹ï¼š
- åœ¨å¤šä¸ªå°ºåº¦ä¸Šæå–å›¾åƒç‰¹å¾
- æœ‰æ•ˆä¿ç•™ç»†èŠ‚ä¿¡æ¯
- æå‡å›¾åƒçš„æ•´ä½“å¯¹æ¯”åº¦å’Œæ¸…æ™°åº¦

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results --multi_scale
```

#### å†…å®¹æ„ŸçŸ¥å¢å¼º (Content-Aware Enhancement)
å†…å®¹æ„ŸçŸ¥å¢å¼ºæŠ€æœ¯ç»“åˆäº†æ˜¾è‘—æ€§æ£€æµ‹å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼Œèƒ½å¤Ÿè¯†åˆ«å›¾åƒä¸­çš„é‡è¦åŒºåŸŸï¼Œå¹¶é’ˆå¯¹æ€§åœ°å¢å¼ºè¿™äº›åŒºåŸŸï¼Œä»è€Œè·å¾—æ›´è‡ªç„¶çš„å¢å¼ºæ•ˆæœã€‚

ç‰¹ç‚¹ï¼š
- è‡ªåŠ¨è¯†åˆ«å›¾åƒä¸­çš„æ˜¾è‘—åŒºåŸŸ
- æ ¹æ®å†…å®¹é‡è¦æ€§è°ƒæ•´å¢å¼ºå¼ºåº¦
- æä¾›æ›´åŠ è‡ªç„¶å’Œç¬¦åˆäººçœ¼è§†è§‰çš„å¢å¼ºæ•ˆæœ

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results --content_aware
```

### 4. TensorBoardç›‘æ§

ä½¿ç”¨TensorBoardç›‘æ§è®­ç»ƒè¿›åº¦ï¼š

```bash
tensorboard --logdir ./checkpoints/logs
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:6006

## ğŸ“Š æŸå¤±å‡½æ•°

æ¨¡å‹ä½¿ç”¨å››ç§æ— ç›‘ç£æŸå¤±å‡½æ•°ï¼š

### 1. æ›å…‰æ§åˆ¶æŸå¤±(L_exp)
çº¦æŸå¢å¼ºå›¾åƒçš„å¹³å‡å¼ºåº¦è¾¾åˆ°ç›®æ ‡æ°´å¹³(0.6)ã€‚

$$\mathcal{L}_{exp} = \frac{1}{M} \sum_{k=1}^{M} |Y_k - E|$$

### 2. ç»“æ„æ„ŸçŸ¥å¹³æ»‘æ€§æŸå¤±(L_smooth)
ç¡®ä¿å…‰ç…§å¹³æ»‘åŒæ—¶ä¿ç•™è¾¹ç¼˜ã€‚

$$\mathcal{L}_{smooth} = \sum || \nabla I \circ \exp(-\lambda |\nabla S|) ||_1$$

### 3. é¢œè‰²æ’å¸¸æ€§æŸå¤±(L_col)
åŸºäºç°åº¦ä¸–ç•Œå‡è®¾æ¥æ ¡æ­£é¢œè‰²åå·®ã€‚

$$\mathcal{L}_{col} = \sum_{\forall (p,q) \in (R,G,B), p \neq q} (J^p - J^q)^2$$

### 4. ç©ºé—´ä¸€è‡´æ€§æŸå¤±(L_spa)
ä¿æŒä»è¾“å…¥åˆ°è¾“å‡ºçš„çº¹ç†ç»“æ„ã€‚

$$\mathcal{L}_{spa} = \frac{1}{K} \sum_{i=1}^{K} || \nabla R_i - \nabla S_i ||^2$$

### æ€»æŸå¤±

$$\mathcal{L}_{total} = \mathcal{L}_{exp} + \omega_{smooth}\mathcal{L}_{smooth} + \omega_{col}\mathcal{L}_{col} + \omega_{spa}\mathcal{L}_{spa}$$

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ models/               # æ¨¡å‹æ¶æ„ç›®å½•
â”‚   â””â”€â”€ model.py          # æ¨¡å‹æ¶æ„(FAM, IENet, UP_Retinex)
â”œâ”€â”€ losses/               # æŸå¤±å‡½æ•°ç›®å½•
â”‚   â””â”€â”€ loss.py           # æŸå¤±å‡½æ•°
â”œâ”€â”€ datasets/             # æ•°æ®åŠ è½½å·¥å…·ç›®å½•
â”‚   â””â”€â”€ dataset.py        # æ•°æ®åŠ è½½å·¥å…·
â”œâ”€â”€ trainers/             # è®­ç»ƒè„šæœ¬ç›®å½•
â”‚   â””â”€â”€ train.py          # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ predictors/           # æ¨ç†è„šæœ¬ç›®å½•
â”‚   â””â”€â”€ predict.py        # æ¨ç†è„šæœ¬
â”œâ”€â”€ enhancers/            # å›¾åƒå¢å¼ºåŠŸèƒ½ç›®å½•
â”‚   â”œâ”€â”€ simple_enhance.py # ç®€åŒ–ç‰ˆå›¾åƒå¢å¼ºæ ¸å¿ƒåŠŸèƒ½
â”‚   â”œâ”€â”€ adaptive_params.py# è‡ªé€‚åº”å‚æ•°è°ƒæ•´æ¨¡å—
â”‚   â”œâ”€â”€ multi_scale.py    # å¤šå°ºåº¦å¢å¼ºæ¨¡å—
â”‚   â””â”€â”€ content_aware.py  # å†…å®¹æ„ŸçŸ¥å¢å¼ºæ¨¡å—
â”œâ”€â”€ utils/                # å®ç”¨å·¥å…·ç›®å½•
â”‚   â””â”€â”€ utils.py          # å®ç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ main.py               # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ simple_enhance.py     # ç®€åŒ–ç‰ˆå›¾åƒå¢å¼ºå·¥å…·ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è®­ç»ƒï¼‰
â”œâ”€â”€ enhancement_comparison_report.md # å¢å¼ºæ•ˆæœå¯¹æ¯”æŠ¥å‘Š
â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–
â”œâ”€â”€ Development Documentation.md  # è¯¦ç»†è§„èŒƒè¯´æ˜
â”œâ”€â”€ REFACTORING_SUMMARY.md       # é‡æ„æ€»ç»“
â””â”€â”€ README.md             # æœ¬æ–‡æ¡£
```

## ğŸ§ª æµ‹è¯•ç»„ä»¶

### æµ‹è¯•æ•´ä¸ªé¡¹ç›®
```bash
python test_project.py
```

### æµ‹è¯•æ¨¡å‹æ¶æ„
```bash
python models/model.py
```

### æµ‹è¯•æŸå¤±å‡½æ•°
```bash
python losses/loss.py
```

### æµ‹è¯•æ•°æ®é›†åŠ è½½å™¨
```bash
python datasets/dataset.py ./data/train
```

## ğŸ”§ è¶…å‚æ•°

é»˜è®¤è¶…å‚æ•°(æ ¹æ®è§„èŒƒ)ï¼š

| å‚æ•° | å€¼ |
|-----------|-------|
| å­¦ä¹ ç‡ | 1e-4 |
| æƒé‡è¡°å‡ | 1e-5 |
| æ‰¹å¤„ç†å¤§å° | 8 |
| å›¾åƒå°ºå¯¸ | 256Ã—256 |
| æ›å…‰æŸå¤±æƒé‡ | 10.0 |
| å¹³æ»‘æ€§æŸå¤±æƒé‡ | 1.0 |
| é¢œè‰²æŸå¤±æƒé‡ | 0.5 |
| ç©ºé—´æŸå¤±æƒé‡ | 1.0 |

## ğŸ“ˆ é¢„æœŸç»“æœ

æ¨¡å‹åº”äº§ç”Ÿï¼š
- **å¢å¼ºå›¾åƒ**ï¼šäº®åº¦å’Œå¯¹æ¯”åº¦å¾—åˆ°æ”¹å–„
- **å…‰ç…§å›¾**ï¼šæ˜¾ç¤ºä¼°è®¡çš„å…‰ç…§åˆ†å¸ƒ
- **å¯¹æ¯”å›¾åƒ**ï¼šæ˜¾ç¤ºè¾“å…¥ã€è¾“å‡ºå’Œå…‰ç…§çš„å¹¶æ’æ¯”è¾ƒ

## ğŸ› æ•…éšœæ’é™¤

### å†…å­˜ä¸è¶³(OOM)é”™è¯¯
- å‡å°‘æ‰¹å¤„ç†å¤§å°ï¼š`--batch_size 4`
- å‡å°‘å›¾åƒå°ºå¯¸ï¼š`--image_size 224`
- å¯¹äºæ¨ç†ï¼Œä½¿ç”¨ï¼š`--max_size 1024`

### è®­ç»ƒæŸå¤±ä¸ä¸‹é™
- æ£€æŸ¥å›¾åƒæ˜¯å¦æ­£ç¡®å½’ä¸€åŒ–[0, 1]
- éªŒè¯æŸå¤±æƒé‡æ˜¯å¦åˆé€‚
- å°è¯•è°ƒæ•´å­¦ä¹ ç‡

### å¢å¼ºè´¨é‡å·®
- è®­ç»ƒæ›´å¤šè½®æ¬¡(æ¨è100-200è½®)
- ç¡®ä¿è®­ç»ƒæ•°æ®å¤šæ ·æ€§å……è¶³
- å¦‚å‡ºç°ç‰¹å®šä¼ªå½±ï¼Œè°ƒæ•´æŸå¤±æƒé‡

### é«˜çº§å¢å¼ºåŠŸèƒ½é—®é¢˜
- ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ï¼š`pip install -r requirements.txt`
- æ£€æŸ¥è¾“å…¥å›¾åƒæ ¼å¼æ˜¯å¦ä¸ºæ”¯æŒçš„æ ¼å¼ï¼ˆJPEG, PNGç­‰ï¼‰
- å¤šå°ºåº¦å¢å¼ºå’Œå†…å®¹æ„ŸçŸ¥å¢å¼ºå¯èƒ½éœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºï¼Œå¦‚æœé‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•å‡å°å›¾åƒå°ºå¯¸ï¼š`--max_size 512`

## ğŸ“š å‚è€ƒæ–‡çŒ®

- Retinexç†è®ºï¼šLand, E. H. (1977). è§†ç½‘è†œç†è®ºä¸è‰²å½©è§†è§‰ã€‚ã€Šç§‘å­¦ç¾å›½äººã€‹ã€‚
- HIDO-Netï¼šç‰¹å¾èšåˆæ¨¡å—çµæ„Ÿæ¥æº

## ğŸ“ å¼•ç”¨

å¦‚æœæ‚¨åœ¨ç ”ç©¶ä¸­ä½¿ç”¨æ­¤ä»£ç ï¼Œè¯·å¼•ç”¨ï¼š
```