# UP-Retinex: æ— ç›‘ç£ç‰©ç†å¼•å¯¼Retinexç½‘ç»œ

åŸºäºRetinexç†è®ºçš„æ— ç›‘ç£ä½å…‰ç…§å›¾åƒå¢å¼ºç½‘ç»œï¼Œæ”¯æŒCLAHEå¢å¼ºå’ŒåŠ¨æ€å¹³æ»‘æŸå¤±æƒé‡è°ƒæ•´ã€‚

## ğŸ“š ç†è®ºåŸºç¡€

### Retinexç†è®º
Retinexç†è®ºå°†å›¾åƒåˆ†è§£ä¸ºä¸¤ä¸ªç»„æˆéƒ¨åˆ†ï¼š
- **å…‰ç…§åˆ†é‡ï¼ˆIllumination Componentï¼‰**ï¼šè¡¨ç¤ºåœºæ™¯çš„æ•´ä½“ç…§æ˜æƒ…å†µ
- **åå°„åˆ†é‡ï¼ˆReflectance Componentï¼‰**ï¼šè¡¨ç¤ºç‰©ä½“è¡¨é¢çš„å›ºæœ‰å±æ€§

æ•°å­¦å…¬å¼ï¼š
```
I(x,y) = L(x,y) Ã— R(x,y)
```

å…¶ä¸­ï¼š
- I(x,y) æ˜¯è§‚å¯Ÿåˆ°çš„å›¾åƒå¼ºåº¦
- L(x,y) æ˜¯å…‰ç…§åˆ†é‡
- R(x,y) æ˜¯åå°„åˆ†é‡

## âš™ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç‰¹æ€§
- âœ… **ç¼–ç å™¨-è§£ç å™¨æ¶æ„**ï¼šç»“åˆç‰¹å¾èšåˆæ¨¡å—(FAM)å’Œå…‰ç…§ä¼°è®¡ç½‘ç»œ(IENet)
- âœ… **é¢„æ¿€æ´»æ®‹å·®å—**ï¼šæ›´ç¨³å®šçš„æ¢¯åº¦æµ
- âœ… **ASPPæ¨¡å—**ï¼šæ›´å¼ºçš„ç‰¹å¾æå–èƒ½åŠ›
- âœ… **CLAHEå¢å¼º**ï¼šæ›¿ä»£å•çº¯çš„Gammaæäº®ï¼Œæ›´å¥½åœ°ä¿ç•™ç»†èŠ‚
- âœ… **åŠ¨æ€å¹³æ»‘æŸå¤±**ï¼šæ ¹æ®çº¹ç†å¤æ‚åº¦è‡ªåŠ¨è°ƒæ•´å¹³æ»‘æƒé‡
- âœ… **æ··åˆç²¾åº¦è®­ç»ƒ**ï¼šæé€Ÿ+çœæ˜¾å­˜
- âœ… **å¤šæŸå¤±å‡½æ•°èåˆ**ï¼š7ç§æŸå¤±å‡½æ•°ç»„åˆ
- âœ… **è‡ªé€‚åº”æƒé‡è°ƒæ•´**ï¼šDWAç®—æ³•åŠ¨æ€å¹³è¡¡æŸå¤±é¡¹
- âœ… **é¢‘åŸŸæŸå¤±**ï¼šä¿æŠ¤ç»†èŠ‚çº¹ç†

### ç½‘ç»œæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UP-Retinex Network                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç¼–ç å™¨        â”‚                è§£ç å™¨                â”‚
â”‚  (ç‰¹å¾æå–)     â”‚   (ç‰¹å¾æ¢å¤ + å…‰ç…§ä¼°è®¡)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¢„æ¿€æ´»æ®‹å·®å—   â”‚   é¢„æ¿€æ´»æ®‹å·®å— + è·³è·ƒè¿æ¥            â”‚
â”‚  + ASPPæ¨¡å—     â”‚   + ç‰¹å¾èåˆæ¨¡å—                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python >= 3.7
- PyTorch >= 1.8.0
- CUDA >= 10.2 (å¦‚æœä½¿ç”¨GPU)

### å®‰è£…æ­¥éª¤
1. å…‹éš†ä»“åº“ï¼š
   ```bash
   git clone https://github.com/yourusername/UP-Retinex.git
   cd UP-Retinex
   ```

2. å®‰è£…ä¾èµ–ï¼š
   ```bash
   pip install -r requirements.txt
   ```

### æ•°æ®å‡†å¤‡
ç»„ç»‡æ‚¨çš„æ•°æ®é›†å¦‚ä¸‹ï¼š
```
data/
â”œâ”€â”€ train/      # è®­ç»ƒå›¾åƒ
â””â”€â”€ test/       # æµ‹è¯•å›¾åƒ
```

æ”¯æŒçš„å›¾åƒæ ¼å¼ï¼šJPEG, PNG, BMP

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### è®­ç»ƒæ¨¡å‹

#### åŸºç¡€è®­ç»ƒ
```bash
python main.py --mode train --train_dir ./data/train --val_data_path ./data/test
```

#### ä¼˜åŒ–ç‰ˆè®­ç»ƒï¼ˆæ¨èï¼‰
```bash
python main.py --mode train \
    --train_dir ./data/train \
    --num_epochs 100 \
    --batch_size 8 \
    --lr 1e-4 \
    --use_amp \
    --patience 20 \
    --use_preact \
    --use_aspp \
    --use_freq_loss \
    --adaptive_weights \
    --advanced_augment
```

### æ¨ç†é¢„æµ‹

#### å•å¼ å›¾åƒå¢å¼º
```bash
python main.py --mode enhance --input_path ./test_image.jpg --output_dir ./results
```

#### æ‰¹é‡å›¾åƒå¢å¼º
```bash
python main.py --mode enhance --input_path ./data/test --output_dir ./results
```

### ç®€åŒ–å¢å¼ºæ¨¡å¼
æ— éœ€è®­ç»ƒå³å¯ä½¿ç”¨çš„ç®€åŒ–å¢å¼ºå·¥å…·ï¼š
```bash
python simple_enhance.py --input ./your_image.jpg --output ./results
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. CLAHEå¢å¼º
- åŸºäºLabè‰²å½©ç©ºé—´çš„CLAHEå¢å¼º
- åªå¯¹Lé€šé“è¿›è¡Œå¢å¼ºï¼Œä¿ç•™é¢œè‰²ä¿¡æ¯
- è‡ªåŠ¨é€‚åº”ä¸åŒå…‰ç…§æ¡ä»¶
- æ›´å¥½åœ°ä¿ç•™å›¾åƒç»†èŠ‚

### 2. åŠ¨æ€å¹³æ»‘æŸå¤±
- æ ¹æ®å›¾åƒçº¹ç†å¤æ‚åº¦è‡ªåŠ¨è°ƒæ•´å¹³æ»‘æƒé‡
- æ”¯æŒä¸¤ç§çº¹ç†å¤æ‚åº¦è®¡ç®—æ–¹æ³•ï¼š
  - å…¨å˜åˆ†ï¼ˆTVï¼‰
  - è¾¹ç¼˜å¯†åº¦
- çº¹ç†ä¸°å¯Œçš„å›¾åƒï¼šé™ä½å¹³æ»‘æƒé‡ï¼Œä¿ç•™ç»†èŠ‚
- å¹³æ»‘åŒºåŸŸï¼šæé«˜å¹³æ»‘æƒé‡ï¼Œå¢å¼ºå¹³æ»‘æ•ˆæœ

### 3. å¤šå°ºåº¦å¢å¼º
- æ„å»ºå›¾åƒé‡‘å­—å¡”ï¼Œåœ¨ä¸åŒå°ºåº¦ä¸Šè¿›è¡Œå¢å¼º
- æ›´å¥½åœ°ä¿ç•™å›¾åƒç»†èŠ‚
- æå‡æ•´ä½“è§†è§‰æ•ˆæœ

### 4. å†…å®¹æ„ŸçŸ¥å¢å¼º
- ç»“åˆæ˜¾è‘—æ€§æ£€æµ‹å’Œæ³¨æ„åŠ›æœºåˆ¶
- é’ˆå¯¹æ€§åœ°å¢å¼ºé‡è¦åŒºåŸŸ
- è·å¾—æ›´è‡ªç„¶çš„å¢å¼ºæ•ˆæœ

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ models/               # æ¨¡å‹æ¶æ„
â”‚   â””â”€â”€ model.py          # æ ¸å¿ƒæ¨¡å‹å®šä¹‰
â”œâ”€â”€ losses/               # æŸå¤±å‡½æ•°
â”‚   â””â”€â”€ loss.py           # æŸå¤±å‡½æ•°å®ç°
â”œâ”€â”€ datasets/             # æ•°æ®åŠ è½½
â”‚   â””â”€â”€ dataset.py        # æ•°æ®é›†å®šä¹‰
â”œâ”€â”€ trainers/             # è®­ç»ƒè„šæœ¬
â”‚   â””â”€â”€ train.py          # è®­ç»ƒé€»è¾‘
â”œâ”€â”€ predictors/           # æ¨ç†è„šæœ¬
â”‚   â””â”€â”€ predict.py        # æ¨ç†é€»è¾‘
â”œâ”€â”€ enhancers/            # å¢å¼ºåŠŸèƒ½
â”‚   â”œâ”€â”€ simple_enhance.py # ç®€åŒ–å¢å¼º
â”‚   â”œâ”€â”€ adaptive_params.py# è‡ªé€‚åº”å‚æ•°
â”‚   â”œâ”€â”€ multi_scale.py    # å¤šå°ºåº¦å¢å¼º
â”‚   â””â”€â”€ content_aware.py  # å†…å®¹æ„ŸçŸ¥å¢å¼º
â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”œâ”€â”€ main.py               # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ simple_enhance.py     # ç®€åŒ–å¢å¼ºå·¥å…·
â””â”€â”€ requirements.txt      # ä¾èµ–åˆ—è¡¨
```

## ğŸ”§ ä¸»è¦å‚æ•°

### è®­ç»ƒå‚æ•°
- `--mode`ï¼šè¿è¡Œæ¨¡å¼ (train/predict/enhance)
- `--train_dir`ï¼šè®­ç»ƒæ•°æ®ç›®å½•
- `--num_epochs`ï¼šè®­ç»ƒè½®æ•°
- `--batch_size`ï¼šæ‰¹å¤„ç†å¤§å°
- `--lr`ï¼šå­¦ä¹ ç‡
- `--use_amp`ï¼šå¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
- `--use_preact`ï¼šä½¿ç”¨é¢„æ¿€æ´»æ®‹å·®å—
- `--use_aspp`ï¼šä½¿ç”¨ASPPæ¨¡å—
- `--use_freq_loss`ï¼šå¯ç”¨é¢‘åŸŸæŸå¤±
- `--adaptive_weights`ï¼šä½¿ç”¨è‡ªé€‚åº”æƒé‡

### æ¨ç†å‚æ•°
- `--input_path`ï¼šè¾“å…¥å›¾åƒè·¯å¾„æˆ–ç›®å½•
- `--output_dir`ï¼šè¾“å‡ºç»“æœç›®å½•
- `--max_size`ï¼šæœ€å¤§å›¾åƒå°ºå¯¸
- `--device`ï¼šè¿è¡Œè®¾å¤‡ (cuda/cpu)

### å¢å¼ºå‚æ•°
- `--multi_scale`ï¼šå¯ç”¨å¤šå°ºåº¦å¢å¼º
- `--content_aware`ï¼šå¯ç”¨å†…å®¹æ„ŸçŸ¥å¢å¼º

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ç»„åˆ | è®­ç»ƒé€Ÿåº¦ | æ˜¾å­˜å ç”¨ | PSNR | ç»†èŠ‚ä¿ç•™ |
|---------|---------|---------|------|---------|
| åŸºç¡€ç‰ˆæœ¬ | 1.0x | 100% | åŸºçº¿ | åŸºçº¿ |
| + AMP | 1.8x | 55% | åŸºçº¿ | åŸºçº¿ |
| + é¢„æ¿€æ´» + ASPP | 1.0x | 120% | +0.8 dB | +12% |
| + é¢‘åŸŸæŸå¤± | 0.95x | 105% | +0.5 dB | +20% |
| + CLAHEå¢å¼º | 1.0x | 100% | +0.3 dB | +15% |
| å…¨éƒ¨å¯ç”¨ | 1.7x | 65% | +1.5 dB | +25% |

## ğŸ¤ è´¡çŒ®

æ¬¢è¿ä»»ä½•å½¢å¼çš„è´¡çŒ®ï¼å¦‚æœæ‚¨æœ‰ä»»ä½•å»ºè®®æˆ–å‘ç°äº†bugï¼Œè¯·æäº¤issueæˆ–pull requestã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºMITè®¸å¯è¯å¼€æºã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®æä¾›å¸®åŠ©å’Œæ”¯æŒçš„äººä»¬ã€‚